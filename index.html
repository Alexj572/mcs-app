<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<link rel="manifest" href="manifest.json">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MCS App">
<meta name="theme-color" content="#2952b3">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MCS ‚Äî M√©canique Concept Saar</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800&family=Barlow:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#0f1b3d;--bg2:#162040;--bg3:#1e2d55;--border:#2a3d6e;--text:#e8ecf4;--text2:#8fa0c8;--accent:#4a90e8;--accent2:#3578d0;--mcs-blue:#2952b3;--mcs-blue2:#4a78e8;--mcs-purple:#6c3db0;--mcs-purple2:#8855d8;--green:#1e7e3a;--green2:#28a04a;--red:#c0281e;--mcs-red:#c0281e;--mcs-red2:#e03020;--blue:#2952b3;--blue2:#4a78e8;--purple:#6c3db0;--radius:14px;--shadow:0 6px 32px rgba(0,0,0,.5)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Barlow',sans-serif;background:linear-gradient(160deg,#0d1a3e 0%,#1a2a5e 50%,#0d1a3e 100%);background-attachment:fixed;color:var(--text);min-height:100vh}
.hidden{display:none!important}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;border:none;border-radius:var(--radius);font-family:'Barlow',sans-serif;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s}
.btn-primary{background:linear-gradient(135deg,var(--mcs-blue) 0%,var(--mcs-blue2) 100%);color:#fff}.btn-primary:hover{opacity:.9;transform:translateY(-1px)}
.btn-blue{background:var(--mcs-blue2);color:#fff}.btn-blue:hover{background:var(--mcs-blue)}
.btn-red{background:var(--red);color:#fff}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border)}.btn-ghost:hover{border-color:var(--accent);color:var(--accent)}
.btn-sm{padding:6px 14px;font-size:13px}
.btn-full{width:100%;justify-content:center}
input,select,textarea{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:10px;color:var(--text);padding:10px 14px;font-family:'Barlow',sans-serif;font-size:14px;width:100%;transition:border .2s}select option{background:#1e2d55;color:#e8ecf4}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent);background:rgba(255,255,255,.12)}
label{font-size:12px;font-weight:600;color:var(--text2);letter-spacing:.05em;text-transform:uppercase;display:block;margin-bottom:6px}
.field{margin-bottom:16px}
.card{background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:var(--radius);padding:20px;backdrop-filter:blur(4px)}
/* MENU HOME BUTTONS */
.home-page{min-height:calc(100vh - 120px);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px 20px;gap:0}
.home-logo{text-align:center;margin-bottom:48px}
.home-logo img{width:180px;height:auto;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.4)}
.home-logo h1{font-family:'Barlow Condensed',sans-serif;font-size:32px;font-weight:800;color:#fff;margin-top:20px;line-height:1.1}
.home-logo p{color:rgba(255,255,255,.55);font-size:14px;margin-top:6px}
.home-menu{width:100%;max-width:480px;display:flex;flex-direction:column;gap:16px}
.home-btn{display:flex;align-items:center;gap:20px;padding:22px 28px;border:none;border-radius:18px;cursor:pointer;width:100%;text-align:left;transition:transform .18s,box-shadow .18s;font-family:'Barlow',sans-serif}
.home-btn:hover{transform:translateY(-2px);box-shadow:0 12px 40px rgba(0,0,0,.4)}
.home-btn:active{transform:translateY(0)}
.home-btn.blue{background:linear-gradient(135deg,#2952b3 0%,#4a78e8 100%)}
.home-btn.purple{background:linear-gradient(135deg,#6c3db0 0%,#9355e8 100%)}
.home-btn.teal{background:linear-gradient(135deg,#1a6e7e 0%,#2aa8c0 100%)}
.home-btn.green{background:linear-gradient(135deg,#1a6e3e 0%,#2aa860 100%)}
.home-btn-icon{font-size:34px;flex-shrink:0;width:50px;text-align:center}
.home-btn-text strong{display:block;font-size:20px;font-weight:700;color:#fff;margin-bottom:3px}
.home-btn-text span{display:block;font-size:13px;color:rgba(255,255,255,.7)}
/* TOAST */
#toast{position:fixed;bottom:24px;right:24px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast-item{background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px 18px;font-size:14px;display:flex;align-items:center;gap:10px;animation:slideIn .3s ease;box-shadow:var(--shadow)}
.toast-item.success{border-color:var(--green2)}.toast-item.error{border-color:var(--red)}
@keyframes slideIn{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}
/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:14px;width:100%;max-width:560px;max-height:90vh;overflow-y:auto}
.modal-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.modal-header h3{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:700}
.modal-body{padding:24px}
.modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end}
.close-btn{background:none;border:none;color:var(--text2);font-size:22px;cursor:pointer;line-height:1}.close-btn:hover{color:var(--text)}
/* LIGHTBOX */
#lightbox{position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:2000;display:flex;align-items:center;justify-content:center;cursor:zoom-out}
#lightbox img{max-width:92vw;max-height:88vh;border-radius:8px;box-shadow:0 0 60px rgba(0,0,0,.8);cursor:default}
#lightbox-close{position:absolute;top:20px;right:24px;background:none;border:none;color:#fff;font-size:36px;cursor:pointer;line-height:1;z-index:2001}
/* LOGIN */
#login-page{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:linear-gradient(160deg,#0d1a3e 0%,#162454 40%,#1a1a5e 100%)}
.login-box{width:100%;max-width:440px;text-align:center}
.login-logo{margin-bottom:36px}
.login-logo img{width:200px;height:auto;margin:0 auto 24px;display:block;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.4)}
.login-logo h1{font-family:'Barlow Condensed',sans-serif;font-size:38px;font-weight:800;letter-spacing:.02em;color:#fff;line-height:1.1;margin-bottom:8px}
.login-logo p{color:rgba(255,255,255,.6);font-size:15px;margin-top:4px}
.login-box .card{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);backdrop-filter:blur(12px);padding:32px;border-radius:20px;text-align:left}
/* APP */
#app{display:flex;flex-direction:column;min-height:100vh}
header{background:rgba(13,26,62,.95);border-bottom:1px solid var(--border);padding:0 20px;height:60px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;backdrop-filter:blur(10px)}
.header-left{display:flex;align-items:center;gap:12px}
.header-logo-img{height:40px;width:auto}
.header-title{font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800;color:var(--accent);letter-spacing:.03em}
.header-sub{font-size:11px;color:var(--text2)}
.header-right{display:flex;align-items:center;gap:10px}
.user-badge{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text2)}
.user-avatar{width:32px;height:32px;border-radius:50%;background:var(--blue);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;color:#fff}
nav{display:flex;gap:4px;padding:0 20px;background:var(--bg2);border-bottom:1px solid var(--border);overflow-x:auto}
nav button{background:none;border:none;color:var(--text2);padding:13px 16px;font-family:'Barlow',sans-serif;font-size:14px;font-weight:500;cursor:pointer;border-bottom:3px solid transparent;transition:all .2s;white-space:nowrap;display:flex;align-items:center;gap:6px}
nav button:hover{color:var(--text)}
nav button.active{color:#fff;border-bottom-color:var(--accent);font-weight:600}
.nav-spacer{flex:1}
nav button.nav-settings{margin-left:auto;color:var(--text2)}
nav button.nav-settings:hover{color:var(--accent)}
main{flex:1;padding:24px 20px;max-width:1200px;margin:0 auto;width:100%}
/* PAGE */
.page-title{font-family:'Barlow Condensed',sans-serif;font-size:32px;font-weight:800;margin-bottom:6px}
.page-sub{color:var(--text2);font-size:14px;margin-bottom:24px}
/* DASHBOARD */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:28px}
.stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:20px;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.stat-card.orange::before{background:var(--accent)}.stat-card.blue::before{background:var(--mcs-blue2)}.stat-card.green::before{background:var(--green2)}.stat-card.red::before{background:var(--mcs-red2)}
.stat-val{font-family:'Barlow Condensed',sans-serif;font-size:40px;font-weight:800;line-height:1}
.stat-icon{font-size:28px;margin-bottom:12px}
.stat-label{color:var(--text2);font-size:13px;margin-top:4px}
.fiche-row{display:flex;align-items:center;gap:14px;padding:12px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s;border-radius:8px}
.fiche-row:hover{background:var(--bg3)}.fiche-row:last-child{border-bottom:none}
.machine-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0}
.fiche-info{flex:1;min-width:0}
.fiche-name{font-weight:600;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.fiche-meta{font-size:12px;color:var(--text2);margin-top:2px}
.fiche-date{font-size:12px;color:var(--text2);flex-shrink:0}
/* MACHINES */
.machines-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
.machine-card{border-radius:var(--radius);padding:20px;cursor:pointer;transition:transform .2s,box-shadow .2s;position:relative;overflow:hidden}
.machine-card:hover{transform:translateY(-3px);box-shadow:0 8px 30px rgba(0,0,0,.4)}
.mc-icon{font-size:32px;margin-bottom:12px}
.mc-count{margin-top:14px;font-size:13px;opacity:.7}
.mc-actions{position:absolute;top:12px;right:12px;display:flex;gap:6px;opacity:0;transition:opacity .2s}
.machine-card:hover .mc-actions{opacity:1}
.mc-btn{background:rgba(0,0,0,.3);border:none;color:#fff;width:28px;height:28px;border-radius:6px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center}
.mc-btn:hover{background:rgba(0,0,0,.5)}
.add-machine-card{border:2px dashed var(--border);border-radius:var(--radius);padding:20px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;cursor:pointer;transition:all .2s;min-height:130px;color:var(--text2)}
.add-machine-card:hover{border-color:var(--accent);color:var(--accent)}
.color-grid{display:flex;flex-wrap:wrap;gap:8px}
.color-swatch{width:34px;height:34px;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:transform .15s,border-color .15s}
.color-swatch:hover{transform:scale(1.15)}.color-swatch.selected{border-color:#fff;transform:scale(1.15)}
/* FICHES TABLE */
.search-wrap{position:relative;flex:1;min-width:200px}
.search-wrap input{padding-left:38px}
.search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text2);font-size:16px}
.fiches-table{width:100%;border-collapse:collapse}
.fiches-table th{text-align:left;padding:10px 14px;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text2);border-bottom:1px solid var(--border)}
.fiches-table td{padding:12px 14px;border-bottom:1px solid var(--border);font-size:14px}
.fiches-table tr:hover td{background:var(--bg3);cursor:pointer}
.fiches-table tr:last-child td{border-bottom:none}
.machine-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600;color:#fff}
.empty-state{text-align:center;padding:60px 20px;color:var(--text2)}
.empty-icon{font-size:48px;margin-bottom:16px}
/* FICHE FORM/VIEW */
.back-btn{background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:8px 14px;border-radius:8px;cursor:pointer;font-size:14px;display:flex;align-items:center;gap:6px;font-family:'Barlow',sans-serif}
.back-btn:hover{border-color:var(--accent);color:var(--accent)}
.section-title{font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:700;margin-bottom:14px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
.form-row-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:14px}
.form-section{margin-bottom:20px}
.remove-btn{background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:8px;border-radius:8px;cursor:pointer;font-size:16px;line-height:1}
.remove-btn:hover{border-color:var(--red);color:var(--red)}
.file-upload-area{border:2px dashed var(--border);border-radius:10px;padding:24px;text-align:center;cursor:pointer;transition:border-color .2s}
.file-upload-area:hover{border-color:var(--accent)}
.file-name-badge{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:6px 10px;font-size:12px;display:inline-flex;align-items:center;gap:6px;margin:4px}
/* IMAGE THUMBNAILS */
.img-thumb-wrap{position:relative;display:inline-block;margin:4px;cursor:pointer}
.img-thumb-wrap img{width:90px;height:90px;object-fit:cover;border-radius:8px;border:2px solid var(--border);transition:border-color .2s;display:block}
.img-thumb-wrap:hover img{border-color:var(--accent)}
.img-thumb-wrap .del-thumb{position:absolute;top:-6px;right:-6px;background:var(--red);color:#fff;border:none;border-radius:50%;width:20px;height:20px;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;line-height:1}
.img-zoom-badge{position:absolute;bottom:4px;right:4px;background:rgba(0,0,0,.6);color:#fff;font-size:10px;padding:2px 5px;border-radius:4px}
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.info-label{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.05em;margin-bottom:3px}
.info-val{font-weight:600;font-size:14px}
.history-item{display:flex;gap:12px;align-items:flex-start;padding:8px 0;border-bottom:1px solid var(--border)}
.history-item:last-child{border-bottom:none}
.history-dot{width:8px;height:8px;border-radius:50%;background:var(--accent);flex-shrink:0;margin-top:5px}
.history-text{font-size:13px}
.history-date{font-size:11px;color:var(--text2);margin-top:2px}
/* DIMS */
.dim-label{font-size:11px;color:var(--text2);text-align:center;margin-top:4px}
/* STATS */
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.chart-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:20px}
.chart-card h4{font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:700;margin-bottom:16px}
.bar-item{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.bar-label{font-size:13px;width:120px;flex-shrink:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.bar-track{flex:1;height:22px;background:var(--bg3);border-radius:4px;overflow:hidden}
.bar-fill{height:100%;border-radius:4px;display:flex;align-items:center;justify-content:flex-end;padding-right:8px;font-size:12px;font-weight:700;color:#000;transition:width .6s ease}
.bar-val{font-size:13px;font-weight:600;width:30px;text-align:right}
/* PRINT */
@media print{
  header,nav,.no-print{display:none!important}
  body{background:#fff!important;color:#000!important}
  .card{background:#fff!important;border:1px solid #ddd!important;break-inside:avoid}
  .section-title{color:#000!important;border-bottom:1px solid #ddd!important}
  .info-label{color:#666!important}
  .stat-card,.machine-card{display:none}
  main{padding:0!important;max-width:100%!important}
  h1,h2,h3,h4{color:#000!important}
  table th{color:#333!important}
  .history-item,.history-date,.history-text{color:#333!important}
}
@media(max-width:768px){main{padding:16px}.charts-grid{grid-template-columns:1fr}.form-row,.form-row-3,.form-row-4{grid-template-columns:1fr}.fiches-table th:nth-child(n+4),.fiches-table td:nth-child(n+4){display:none}}
@media(max-width:480px){.stats-grid{grid-template-columns:1fr 1fr}.machines-grid{grid-template-columns:1fr}}
::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

#crop-modal{position:fixed;inset:0;background:rgba(0,0,0,0.93);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px}
#crop-modal.hidden{display:none}
#crop-container{position:relative;display:inline-block;max-width:90vw}
#crop-img{display:block;max-width:90vw;max-height:65vh;object-fit:contain}
#crop-box{position:absolute;border:3px solid #fff;box-shadow:0 0 0 9999px rgba(0,0,0,0.55);cursor:move;touch-action:none;box-sizing:border-box}
.crop-handle{position:absolute;width:28px;height:28px;background:#fff;border-radius:50%;border:2px solid #1e2d55;touch-action:none;z-index:10}
.crop-handle.tl{top:-14px;left:-14px}.crop-handle.tr{top:-14px;right:-14px}
.crop-handle.bl{bottom:-14px;left:-14px}.crop-handle.br{bottom:-14px;right:-14px}

</style>
</head>
<body>

<div id="toast"></div>

<!-- LIGHTBOX -->
<div id="lightbox" class="hidden" onclick="closeLightbox()">
  <button id="lightbox-close" onclick="closeLightbox()">‚úï</button>
  <img id="lightbox-img" src="" alt="" onclick="event.stopPropagation()">
</div>

<!-- LOGIN -->
<div id="login-page">
<div class="login-box">
  <div class="login-logo">
    <img id="logo-img" src="" alt="MCS Logo">
    <h1>M√©canique Concept Saar</h1>
    <p>Syst√®me de Gestion de Production</p>
  </div>
  <div class="card">
    <div class="field"><label>Identifiant</label><input type="text" id="login-user" placeholder="Identifiant" autocomplete="username"></div>
    <div class="field"><label>Mot de passe</label><input type="password" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"></div>
    <button class="btn btn-primary btn-full" onclick="doLogin()" style="margin-top:8px;border-radius:12px;padding:14px;font-size:16px">üîê Se connecter</button>

  </div>
</div>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <header>
    <div class="header-left">
      <img id="header-logo" src="" alt="MCS" class="header-logo-img">
      <div><div class="header-title">MCS</div><div class="header-sub">Gestion de Production</div></div>
    </div>
    <div class="header-right">
      <button id="pwa-install-btn" class="btn btn-ghost btn-sm hidden" onclick="installPWA()" style="font-size:12px">üì≤ Installer l'app</button>
      <div class="user-badge"><div class="user-avatar" id="user-avatar">A</div><span id="user-name">Admin</span></div>
      <button class="btn btn-ghost btn-sm" onclick="doLogout()">D√©connexion</button>
    </div>
  </header>
  <nav>
    <button onclick="goTo('home')" id="nav-home">üè† Accueil</button>
    <button onclick="goTo('fiche-new')" id="nav-fiche">‚ûï Ajouter une fiche</button>
    <button onclick="goTo('fiches')" id="nav-fiches">üìÑ Gestion des fiches</button>
    <div class="nav-spacer"></div>
    <button onclick="goTo('settings')" id="nav-settings" class="nav-settings">‚öôÔ∏è Param√®tres</button>
  </nav>
  <main id="main"></main>
</div>

<!-- MODAL MACHINE -->
<div class="modal-overlay hidden" id="modal-machine">
  <div class="modal">
    <div class="modal-header"><h3 id="modal-machine-title">Ajouter une Machine</h3><button class="close-btn" onclick="closeModal('modal-machine')">‚úï</button></div>
    <div class="modal-body">
      <div class="field"><label>Nom *</label><input type="text" id="m-nom" placeholder="Ex: SMEC SL-3500"></div>
      <div class="field"><label>Type *</label><input type="text" id="m-type" placeholder="Ex: Tour, Fraiseuse..."></div>
      <div class="field"><label>Couleur *</label><div class="color-grid" id="color-grid"></div></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-machine')">Annuler</button>
      <button class="btn btn-primary" onclick="saveMachine()">üíæ Enregistrer</button>
    </div>
  </div>
</div>

<!-- MODAL COMMANDE -->
<div class="modal-overlay hidden" id="modal-commande">
  <div class="modal">
    <div class="modal-header"><h3>Ajouter une Commande</h3><button class="close-btn" onclick="closeModal('modal-commande')">‚úï</button></div>
    <div class="modal-body">
      <div class="form-row">
        <div class="field"><label>Date *</label><input type="date" id="cmd-date"></div>
        <div class="field"><label>N¬∞ Commande *</label><input type="text" id="cmd-num" placeholder="CMD-2026-001"></div>
      </div>
      <div class="form-row">
        <div class="field"><label>Quantit√© *</label><input type="number" id="cmd-qty" placeholder="100" min="1"></div>
        <div class="field"><label>Remarque</label><input type="text" id="cmd-rem" placeholder="Optionnel"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-commande')">Annuler</button>
      <button class="btn btn-primary" onclick="saveCommande()">‚úÖ Ajouter</button>
    </div>
  </div>
</div>

<!-- MODAL DELETE -->
<div class="modal-overlay hidden" id="modal-delete">
  <div class="modal" style="max-width:400px">
    <div class="modal-header"><h3>‚ö†Ô∏è Confirmation</h3><button class="close-btn" onclick="closeModal('modal-delete')">‚úï</button></div>
    <div class="modal-body"><p id="delete-msg" style="font-size:15px;line-height:1.6"></p></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-delete')">Annuler</button>
      <button class="btn btn-red" id="delete-ok">üóëÔ∏è Supprimer</button>
    </div>
  </div>
</div>

<script>
const LOGO_DATA='data:image/jpeg;base64,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';
document.getElementById('logo-img').src=LOGO_DATA;
document.getElementById('header-logo').src=LOGO_DATA;

// ‚îÄ‚îÄ DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const USERS=[{id:'AJensen',name:'A. Jensen',pass:'Mcs2023@AJ',role:'admin'},{id:'CHaar',name:'C. Haar',pass:'Mcs2023@CH',role:'user'},{id:'MRichert',name:'M. Richert',pass:'Mcs2023@MR',role:'user'}];
const COLORS=['#2ecc71','#3498db','#e74c3c','#f39c12','#9b59b6','#e91e63','#1abc9c','#ff5722','#00bcd4','#8bc34a','#f44336','#673ab7','#2196f3','#ff9800','#607d8b','#4caf50','#ffeb3b','#9e9e9e','#ff4081','#536dfe','#69f0ae','#ff6d00'];

// Config des champs de dimensions par forme
const DIMS_CONFIG={
  'Rond':      [{id:'d1',label:'√ò Diam√®tre',ph:'ex: 50',unit:'mm'},{id:'d2',label:'Longueur',ph:'ex: 1000',unit:'mm'}],
  'Carr√©':     [{id:'d1',label:'C√¥t√©',ph:'ex: 40',unit:'mm'},{id:'d2',label:'Longueur',ph:'ex: 500',unit:'mm'}],
  'Rectangle': [{id:'d1',label:'Largeur',ph:'ex: 60',unit:'mm'},{id:'d2',label:'Hauteur',ph:'ex: 30',unit:'mm'},{id:'d3',label:'Longueur',ph:'ex: 500',unit:'mm'}],
  'Hexagonal': [{id:'d1',label:'C√¥t√© plat',ph:'ex: 32',unit:'mm'},{id:'d2',label:'Longueur',ph:'ex: 300',unit:'mm'}],
  'Tube':      [{id:'d1',label:'√ò Ext√©rieur',ph:'ex: 60',unit:'mm'},{id:'d2',label:'√ò Int√©rieur',ph:'ex: 50',unit:'mm'},{id:'d3',label:'Longueur',ph:'ex: 1000',unit:'mm'}],
  'Plaque':    [{id:'d1',label:'Largeur',ph:'ex: 200',unit:'mm'},{id:'d2',label:'Longueur',ph:'ex: 400',unit:'mm'},{id:'d3',label:'√âpaisseur',ph:'ex: 20',unit:'mm'}],
  'Autre':     null,
};

// ‚îÄ‚îÄ SUPABASE CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SUPABASE_URL='https://vvojrtdrchxdueudxqfm.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2b2pydGRyY2h4ZHVldWR4cWZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzgyODcsImV4cCI6MjA4NzYxNDI4N30.OQEXCVB4FZAM8iVsF9XrPWsW_j_P2VHlUg0advASv00';
const API=SUPABASE_URL+'/rest/v1';
const HEADERS={'apikey':SUPABASE_KEY,'Authorization':'Bearer '+SUPABASE_KEY,'Content-Type':'application/json','Prefer':'return=representation'};

async function sbGet(table){
  const r=await fetch(API+'/'+table+'?select=*&apikey='+SUPABASE_KEY,{headers:HEADERS});
  return r.json();
}
async function sbInsert(table,obj){
  const r=await fetch(API+'/'+table+'?apikey='+SUPABASE_KEY,{method:'POST',headers:HEADERS,body:JSON.stringify(obj)});
  return r.json();
}
async function sbUpdate(table,id,obj){
  const r=await fetch(API+'/'+table+'?id=eq.'+id+'&apikey='+SUPABASE_KEY,{method:'PATCH',headers:{...HEADERS,'Prefer':'return=minimal'},body:JSON.stringify(obj)});
  return r.ok;
}
async function sbDelete(table,id){
  const r=await fetch(API+'/'+table+'?id=eq.'+id+'&apikey='+SUPABASE_KEY,{method:'DELETE',headers:HEADERS});
  return r.ok;
}
async function sbDeleteMany(table,field,value){
  const r=await fetch(API+'/'+table+'?'+field+'=eq.'+value+'&apikey='+SUPABASE_KEY,{method:'DELETE',headers:HEADERS});
  return r.ok;
}
async function sbDeleteAll(table){
  const r=await fetch(API+'/'+table+'?id=neq.___none___&apikey='+SUPABASE_KEY,{method:'DELETE',headers:HEADERS});
  return r.ok;
}

function genId(){return Date.now().toString(36)+Math.random().toString(36).substr(2,5)}
function fmt(d){if(!d)return'‚Äî';return new Date(d).toLocaleDateString('fr-FR')}

let machines=[];
let fiches=[];
let currentUser=null,editMachineId=null,selectedColor=COLORS[0],pendingDelete=null;
let formOps=[],formCmds=[],formFiles=[],editFicheId=null;
let currentPage='dashboard',currentFilter=null,currentFicheId=null;
let dbReady=false;

// Convertit objet fiche Supabase ‚Üí format app
function ficheFromDB(row){
  return {
    id:row.id, date:row.fiche_date, client:row.client, planRef:row.plan_ref,
    designation:row.designation, machineId:row.machine_id, matiere:row.matiere,
    forme:row.forme, dims:row.dims||{}, operations:row.operations||[],
    commandes:row.commandes||[], remarques:row.remarques, files:row.files||[],
    history:row.history||[], createdAt:row.created_at, updatedAt:row.updated_at,
    createdBy:row.created_by
  };
}
// Convertit objet fiche app ‚Üí format Supabase
function ficheToDB(f){
  return {
    id:f.id, fiche_date:f.date, client:f.client||null, plan_ref:f.planRef||null,
    designation:f.designation||null, machine_id:f.machineId||null, matiere:f.matiere||null,
    forme:f.forme||null, dims:f.dims||null, operations:f.operations||[],
    commandes:f.commandes||[], remarques:f.remarques||null, files:f.files||[],
    history:f.history||[], created_at:f.createdAt||null, updated_at:f.updatedAt||null,
    created_by:f.createdBy||null
  };
}

async function loadAllData(){
  try{
    const [ms,fs]=await Promise.all([sbGet('machines'),sbGet('fiches')]);
    if(Array.isArray(ms)) machines=ms;
    else{ console.warn('machines error',ms); machines=[]; }
    if(Array.isArray(fs)) fiches=fs.map(ficheFromDB);
    else{ console.warn('fiches error',fs); fiches=[]; }
    dbReady=true;
    return true;
  }catch(e){
    console.error('Supabase error',e);
    toast('Erreur r√©seau ‚Äî v√©rifiez la connexion','error');
    return false;
  }
}

async function svMachines_add(m){
  await sbInsert('machines',{id:m.id,nom:m.nom,type:m.type,color:m.color});
}
async function svMachines_update(m){
  await sbUpdate('machines',m.id,{nom:m.nom,type:m.type,color:m.color});
}
async function svMachines_delete(id){
  await sbDelete('machines',id);
}
async function svFiches_add(f){
  await sbInsert('fiches',ficheToDB(f));
}
async function svFiches_update(f){
  await sbUpdate('fiches',f.id,ficheToDB(f));
}
async function svFiches_delete(id){
  await sbDelete('fiches',id);
}
async function svFiches_deleteByMachine(machineId){
  await sbDeleteMany('fiches','machine_id',machineId);
}
async function svFiches_deleteAll(){
  await sbDeleteAll('fiches');
}

function getMachine(id){return machines.find(m=>m.id===id)}
function getFiche(id){return fiches.find(f=>f.id===id)}

// ‚îÄ‚îÄ LIGHTBOX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openLightbox(src){
  document.getElementById('lightbox-img').src=src;
  document.getElementById('lightbox').classList.remove('hidden');
}
function closeLightbox(){
  document.getElementById('lightbox').classList.add('hidden');
  document.getElementById('lightbox-img').src='';
}
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeLightbox()});

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function doLogin(){
  const u=document.getElementById('login-user').value.trim();
  const p=document.getElementById('login-pass').value;
  const found=USERS.find(x=>x.id===u&&x.pass===p);
  if(!found){toast('Identifiants incorrects','error');return}
  currentUser=found;
  document.getElementById('login-page').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
  document.getElementById('user-avatar').textContent=found.name[0];
  document.getElementById('user-name').textContent=found.name;
  // Afficher loading
  document.getElementById('main').innerHTML='<div style="text-align:center;padding:60px;color:var(--text2)"><div style="font-size:48px;margin-bottom:16px">‚è≥</div><p>Chargement des donn√©es...</p></div>';
  await loadAllData();
  goTo('home');
  toast('Bienvenue, '+found.name+' !');
}
function doLogout(){
  currentUser=null;
  document.getElementById('app').classList.add('hidden');
  document.getElementById('login-page').classList.remove('hidden');
  document.getElementById('login-user').value='';
  document.getElementById('login-pass').value='';
}
document.getElementById('login-pass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin()});

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function goTo(page,data){
  currentPage=page;
  currentFilter=data||null;
  ['home','fiche','fiches','settings'].forEach(p=>{
    const btn=document.getElementById('nav-'+p);
    if(btn)btn.classList.remove('active');
  });
  if(page==='home'){const b=document.getElementById('nav-home');if(b)b.classList.add('active')}
  else if(page==='fiche-new'){const b=document.getElementById('nav-fiche');if(b)b.classList.add('active')}
  else if(page==='fiches'||page==='fiche-view'||page==='fiche-edit'){const b=document.getElementById('nav-fiches');if(b)b.classList.add('active')}
  else if(page==='settings'){const b=document.getElementById('nav-settings');if(b)b.classList.add('active')}
  const main=document.getElementById('main');
  if(page==='home')main.innerHTML=renderHome();
  else if(page==='dashboard')main.innerHTML=renderHome();
  else if(page==='machines')main.innerHTML=renderSettings();
  else if(page==='fiches')main.innerHTML=renderFichesList(data);
  else if(page==='fiche-new'){main.innerHTML=renderFicheForm(null,data);initFormTables();fillDatalistsOptions()}
  else if(page==='fiche-edit'){main.innerHTML=renderFicheForm(data,null);initFormTables();fillDatalistsOptions()}
  else if(page==='fiche-view')main.innerHTML=renderFicheView(data);
  else if(page==='stats')main.innerHTML=renderStats();
  else if(page==='settings')main.innerHTML=renderSettings();
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toast(msg,type='success'){
  const t=document.getElementById('toast');
  const el=document.createElement('div');
  el.className='toast-item '+type;
  el.innerHTML=(type==='success'?'‚úÖ':'‚ùå')+' '+msg;
  t.appendChild(el);
  setTimeout(()=>el.remove(),3500);
}

// ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function closeModal(id){document.getElementById(id).classList.add('hidden')}
function openModal(id){document.getElementById(id).classList.remove('hidden')}
document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.add('hidden')}));

// ‚îÄ‚îÄ HOME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderHome(){
  const tF=fiches.length;
  const now=new Date();
  const tMonth=fiches.filter(f=>{const d=new Date(f.date);return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear()}).length;
  return`<div class="home-page">
    <div class="home-logo">
      <img src="${LOGO_DATA}" alt="MCS">
      <h1>M√©canique Concept Saar</h1>
      <p>Syst√®me de Gestion de Production</p>
    </div>
    <div class="home-menu">
      <button class="home-btn blue" onclick="goTo('fiche-new')">
        <div class="home-btn-icon">üìù</div>
        <div class="home-btn-text"><strong>Nouvelle Fiche</strong><span>Cr√©er une fiche de production</span></div>
      </button>
      <button class="home-btn blue" onclick="goTo('fiches')">
        <div class="home-btn-icon">üìÑ</div>
        <div class="home-btn-text"><strong>Fiches de Production</strong><span>G√©rer les fiches ¬∑ ${tF} fiche${tF>1?'s':''} ¬∑ ${tMonth} ce mois</span></div>
      </button>
      <button class="home-btn teal" onclick="goTo('stats')">
        <div class="home-btn-icon">üìä</div>
        <div class="home-btn-text"><strong>Statistiques</strong><span>Analyse et suivi de production</span></div>
      </button>
      <button class="home-btn purple" onclick="goTo('settings')">
        <div class="home-btn-icon">‚öôÔ∏è</div>
        <div class="home-btn-text"><strong>Param√®tres</strong><span>Configuration machines & donn√©es</span></div>
      </button>
    </div>
  </div>`;
}

// ‚îÄ‚îÄ MACHINES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMachines(){
  return`<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px">
    <div><h1 class="page-title">Machines</h1><p class="page-sub">Configuration des machines CNC</p></div>
    <button class="btn btn-primary" onclick="openAddMachine()">+ Ajouter une machine</button>
  </div>
  <div class="machines-grid">
    ${machines.map(m=>{const cnt=fiches.filter(f=>f.machineId===m.id).length;return`
      <div class="machine-card" style="background:${m.color}20;border:1px solid ${m.color}40" onclick="goTo('fiches',{machineId:'${m.id}'})">
        <div class="mc-actions">
          <button class="mc-btn" onclick="event.stopPropagation();openEditMachine('${m.id}')">‚úèÔ∏è</button>
          <button class="mc-btn" onclick="event.stopPropagation();confirmDelMachine('${m.id}')">üóëÔ∏è</button>
        </div>
        <div class="mc-icon" style="color:${m.color}">üè≠</div>
        <h3 style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;color:${m.color}">${m.nom}</h3>
        <div style="font-size:13px;opacity:.8;color:${m.color}">${m.type}</div>
        <div class="mc-count">${cnt} fiche${cnt>1?'s':''}</div>
      </div>`}).join('')}
    <div class="add-machine-card" onclick="openAddMachine()"><span style="font-size:30px">‚ûï</span><span style="font-size:14px;font-weight:600">Nouvelle machine</span></div>
  </div>`;
}
function buildColorGrid(sel){
  const g=document.getElementById('color-grid');if(!g)return;
  g.innerHTML=COLORS.map(c=>`<div class="color-swatch${c===sel?' selected':''}" style="background:${c}" onclick="selectColor('${c}',this)"></div>`).join('');
}
function selectColor(c,el){selectedColor=c;document.querySelectorAll('.color-swatch').forEach(s=>s.classList.remove('selected'));el.classList.add('selected')}
function openAddMachine(){
  editMachineId=null;selectedColor=COLORS[0];
  document.getElementById('m-nom').value='';document.getElementById('m-type').value='';
  document.getElementById('modal-machine-title').textContent='Ajouter une Machine';
  openModal('modal-machine');setTimeout(()=>buildColorGrid(selectedColor),50);
}
function openEditMachine(id){
  const m=getMachine(id);if(!m)return;
  editMachineId=id;selectedColor=m.color;
  document.getElementById('m-nom').value=m.nom;document.getElementById('m-type').value=m.type;
  document.getElementById('modal-machine-title').textContent='Modifier la Machine';
  openModal('modal-machine');setTimeout(()=>buildColorGrid(selectedColor),50);
}
async function saveMachine(){
  const nom=document.getElementById('m-nom').value.trim();
  const type=document.getElementById('m-type').value.trim();
  if(!nom||!type){toast('Nom et type obligatoires','error');return}
  if(editMachineId){
    const m=getMachine(editMachineId);
    m.nom=nom;m.type=type;m.color=selectedColor;
    await svMachines_update(m);
    toast('Machine modifi√©e ‚úì');
  } else {
    const m={id:genId(),nom,type,color:selectedColor};
    machines.push(m);
    await svMachines_add(m);
    toast('Machine ajout√©e ‚úì');
  }
  closeModal('modal-machine');
  document.getElementById('main').innerHTML=renderSettings();
}
function confirmDelMachine(id){
  const m=getMachine(id);if(!m)return;
  const cnt=fiches.filter(f=>f.machineId===id).length;
  document.getElementById('delete-msg').textContent=`Supprimer "${m.nom}" ?${cnt>0?' '+cnt+' fiche(s) associ√©e(s) seront supprim√©es.':''}`;
  document.getElementById('delete-ok').onclick=async()=>{
    machines=machines.filter(x=>x.id!==id);
    fiches=fiches.filter(f=>f.machineId!==id);
    await svMachines_delete(id);
    await svFiches_deleteByMachine(id);
    closeModal('modal-delete');
    document.getElementById('main').innerHTML=renderSettings();
    toast('Machine supprim√©e');
  };
  openModal('modal-delete');
}

// ‚îÄ‚îÄ FICHES LIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderFichesList(filter){
  const mid=filter&&filter.machineId?filter.machineId:null;
  const machine=mid?getMachine(mid):null;
  let list=mid?fiches.filter(f=>f.machineId===mid):[...fiches];
  list=list.sort((a,b)=>new Date(b.updatedAt||b.date)-new Date(a.updatedAt||a.date));
  return`<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px">
    <div style="display:flex;align-items:center;gap:14px">
      ${machine?`<button class="back-btn" onclick="goTo('machines')">‚Üê Retour</button>`:''}
      <div><h1 class="page-title"${machine?` style="color:${machine.color}"`:''}>${machine?machine.nom:'Toutes les Fiches'}</h1>
      <p class="page-sub">${machine?machine.type+' ‚Äî ':''} ${list.length} fiche(s)</p></div>
    </div>
    <button class="btn btn-primary" onclick="goTo('fiche-new',${mid?`{machineId:'${mid}'}`:'null'})">+ Nouvelle fiche</button>
  </div>
  <div class="card" style="padding:0">
    <div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;gap:12px;flex-wrap:wrap">
      <div class="search-wrap"><span class="search-icon">üîç</span><input type="text" id="search-input" placeholder="Rechercher d√©signation, plan, commande, client, mati√®re..." oninput="filterList(this.value,currentMachineFilter)"></div>
      <select id="machine-filter" onchange="filterByMachine(this.value)" style="width:200px"><option value="">Toutes les machines</option>${machines.map(m=>`<option value="${m.id}"${mid===m.id?' selected':''}>${m.nom}</option>`).join('')}</select>
    </div>
    <div id="fiches-body">${renderTable(list)}</div>
  </div>`;
}
function renderTable(list){
  if(!list.length)return`<div class="empty-state"><div class="empty-icon">üì≠</div><p>Aucune fiche trouv√©e</p></div>`;
  return`<table class="fiches-table"><thead><tr><th></th><th>D√©signation</th><th>Machine</th><th>Client</th><th>Mati√®re</th><th>Date</th><th style="width:80px">Actions</th></tr></thead><tbody>
  ${list.map(f=>{const m=getMachine(f.machineId)||{color:'#888',nom:'?'};return`<tr onclick="goTo('fiche-view','${f.id}')">
    <td style="padding:0;width:4px"><div style="width:4px;height:100%;min-height:48px;background:${m.color};border-radius:4px 0 0 4px"></div></td>
    <td><strong>${f.designation||'‚Äî'}</strong><br><span style="color:var(--text2);font-size:12px">${f.planRef||''}</span></td>
    <td><span class="machine-badge" style="background:${m.color}30;color:${m.color};border:1px solid ${m.color}50">${m.nom}</span></td>
    <td>${f.client||'‚Äî'}</td><td>${f.matiere||'‚Äî'}</td><td style="white-space:nowrap">${fmt(f.date)}</td>
    <td onclick="event.stopPropagation()" style="white-space:nowrap">
      <button class="btn btn-ghost btn-sm" onclick="goTo('fiche-edit','${f.id}')">‚úèÔ∏è</button>
      <button class="btn btn-ghost btn-sm" onclick="confirmDelFiche('${f.id}')">üóëÔ∏è</button>
    </td></tr>`}).join('')}
  </tbody></table>`;
}
let currentMachineFilter='';
function filterList(q,mid){
  q=(q||'').toLowerCase();
  currentMachineFilter=mid||'';
  let list=mid?fiches.filter(f=>f.machineId===mid):[...fiches];
  if(q)list=list.filter(f=>{
    if((f.designation||'').toLowerCase().includes(q))return true;
    if((f.planRef||'').toLowerCase().includes(q))return true;
    if((f.client||'').toLowerCase().includes(q))return true;
    if((f.matiere||'').toLowerCase().includes(q))return true;
    if((f.remarques||'').toLowerCase().includes(q))return true;
    if((f.commandes||[]).some(c=>(c.num||'').toLowerCase().includes(q)))return true;
    if((f.operations||[]).some(o=>(o.programme||'').toLowerCase().includes(q)))return true;
    return false;
  });
  document.getElementById('fiches-body').innerHTML=renderTable(list);
}
function filterByMachine(mid){
  currentMachineFilter=mid||'';
  const q=(document.getElementById('search-input')||{}).value||'';
  filterList(q,mid);
}
function confirmDelFiche(id){
  const f=getFiche(id);if(!f)return;
  document.getElementById('delete-msg').textContent=`Supprimer la fiche "${f.designation||f.planRef||'Sans titre'}\" ? Cette action est irr√©versible.`;
  document.getElementById('delete-ok').onclick=async()=>{
    fiches=fiches.filter(x=>x.id!==id);
    await svFiches_delete(id);
    closeModal('modal-delete');goTo('fiches',currentFilter);toast('Fiche supprim√©e');
  };
  openModal('modal-delete');
}

// ‚îÄ‚îÄ DIMENSIONS HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getDimsCfg(forme){return DIMS_CONFIG[forme]!==undefined?DIMS_CONFIG[forme]:DIMS_CONFIG['Rond']}
function renderDimsFields(forme,vals){
  const cfg=getDimsCfg(forme);
  // Forme "Autre" => champ texte libre
  if(cfg===null){
    return`<div class="field" style="grid-column:span 3">
      <label>Description du brut</label>
      <input type="text" id="dim-desc" placeholder="D√©crivez la forme et les dimensions..." value="${vals&&vals.desc||''}">
    </div>`;
  }
  return`<div style="display:grid;grid-template-columns:repeat(${cfg.length},1fr);gap:12px">
  ${cfg.map(d=>`<div class="field">
    <label>${d.label} (${d.unit})</label>
    <input type="text" id="dim-${d.id}" placeholder="${d.ph}" value="${vals&&vals[d.id]||''}">
  </div>`).join('')}
  </div>`;
}
function getDimsValues(){
  const forme=document.getElementById('f-forme').value;
  const cfg=getDimsCfg(forme);
  if(cfg===null){
    const el=document.getElementById('dim-desc');
    return{desc:el?el.value.trim():''};
  }
  const vals={};
  cfg.forEach(d=>{const el=document.getElementById('dim-'+d.id);if(el)vals[d.id]=el.value.trim()});
  return vals;
}
function updateDimsFields(){
  const forme=document.getElementById('f-forme').value;
  const container=document.getElementById('dims-container');
  if(container)container.innerHTML=renderDimsFields(forme,null);
}
function formatDimsDisplay(forme,dims){
  if(!dims)return'‚Äî';
  const cfg=getDimsCfg(forme||'Rond');
  if(cfg===null) return dims.desc||'‚Äî';
  const parts=cfg.map(d=>{const v=dims[d.id];return v?`${d.label}: ${v} mm`:null}).filter(Boolean);
  return parts.length?parts.join(' ¬∑ '):'‚Äî';
}

// ‚îÄ‚îÄ FICHE FORM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderFicheForm(ficheId,initData){
  editFicheId=ficheId||null;
  const f=ficheId?getFiche(ficheId):null;
  const preMid=initData&&initData.machineId?initData.machineId:(f?f.machineId:'');
  const today=new Date().toISOString().split('T')[0];
  const initForme=f?f.forme||'Rond':'Rond';
  formOps=f?JSON.parse(JSON.stringify(f.operations||[{opNum:1,programme:'',tempsCycle:''}])):[{opNum:1,programme:'',tempsCycle:''}];
  formCmds=f?JSON.parse(JSON.stringify(f.commandes||[])):[];
  formFiles=[];
  deletedExistingFiles=[];
  const existingFiles=f&&f.files?f.files:[];
    const _client=f&&f.client?f.client:'';
  const _matiere=f&&f.matiere?f.matiere:'';
  return`<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px" class="no-print">
    <div style="display:flex;align-items:center;gap:14px">
      <button class="back-btn" id="form-back">‚Üê Retour</button>
      <h2 style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:800">${ficheId?'Modifier la Fiche':'Nouvelle Fiche'}</h2>
    </div>
    <button class="btn btn-primary" onclick="submitFiche()">üíæ Enregistrer</button>
  </div>
  <div class="card form-section">
    <div class="section-title">‚ÑπÔ∏è Informations g√©n√©rales</div>
    <div class="form-row">
      <div class="field"><label>Date *</label><input type="date" id="f-date" value="${f?f.date:today}"></div>
      <div class="field"><label>Client</label>
        <input type="text" id="f-client" placeholder="Ex: P.W." value="${_client}" list="clients-list" autocomplete="off">
        <datalist id="clients-list"></datalist>
      </div>
    </div>
    <div class="form-row">
      <div class="field"><label>N¬∞ Plan / R√©f√©rence</label><input type="text" id="f-plan" placeholder="PLAN-2026-001" value="${f?f.planRef||'':''}"></div>
      <div class="field"><label>D√©signation</label><input type="text" id="f-design" placeholder="Ex: Axe principal" value="${f?f.designation||'':''}"></div>
    </div>
    <div class="field"><label>Machine *</label>
      <select id="f-machine">
        <option value="">‚Äî S√©lectionner ‚Äî</option>
        ${machines.map(m=>`<option value="${m.id}"${preMid===m.id?' selected':''}>${m.nom} (${m.type})</option>`).join('')}
      </select>
    </div>
  </div>
  <div class="card form-section">
    <div class="section-title">üî© Mati√®re & Dimensions du brut</div>
    <div class="form-row" style="margin-bottom:16px">
      <div class="field"><label>Mati√®re *</label>
        <input type="text" id="f-mat" placeholder="Ex: Acier 316L" value="${_matiere}" list="matieres-list" autocomplete="off">
        <datalist id="matieres-list"></datalist>
      </div>
      <div class="field"><label>Forme du brut</label>
        <select id="f-forme" onchange="updateDimsFields()">
          ${Object.keys(DIMS_CONFIG).map(x=>`<option${initForme===x?' selected':''}>${x}</option>`).join('')}
        </select>
      </div>
    </div>
    <div id="dims-container">${renderDimsFields(initForme,f?f.dims:null)}</div>
  </div>
  <div class="card form-section">
    <div class="section-title">‚öôÔ∏è Programmes / Op√©rations</div>
    <div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse">
      <thead><tr>
        <th style="text-align:left;padding:8px 10px;font-size:12px;color:var(--text2);text-transform:uppercase;border-bottom:1px solid var(--border)">OP N¬∞</th>
        <th style="text-align:left;padding:8px 10px;font-size:12px;color:var(--text2);text-transform:uppercase;border-bottom:1px solid var(--border)">N¬∞ Programme</th>
        <th style="text-align:left;padding:8px 10px;font-size:12px;color:var(--text2);text-transform:uppercase;border-bottom:1px solid var(--border)">Temps Cycle (mn)</th>
        <th style="text-align:left;padding:8px 10px;font-size:12px;color:var(--text2);text-transform:uppercase;border-bottom:1px solid var(--border)">Infos</th>
        <th style="padding:8px 10px;border-bottom:1px solid var(--border)"></th>
      </tr></thead>
      <tbody id="ops-tbody"></tbody>
    </table></div>
    <button type="button" class="btn btn-ghost btn-sm" style="margin-top:12px" onclick="addOp()">+ Ajouter op√©ration</button>
  </div>
  <div class="card form-section">
    <div class="section-title">üì¶ Historique des Commandes</div>
    <div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse">
      <thead><tr>
        <th style="text-align:left;padding:8px 10px;font-size:12px;color:var(--text2);text-transform:uppercase;border-bottom:1px solid var(--border)">Date</th>
        <th style="text-align:left;padding:8px 10px;font-size:12px;color:var(--text2);text-transform:uppercase;border-bottom:1px solid var(--border)">N¬∞ Commande</th>
        <th style="text-align:left;padding:8px 10px;font-size:12px;color:var(--text2);text-transform:uppercase;border-bottom:1px solid var(--border)">Quantit√©</th>
        <th style="text-align:left;padding:8px 10px;font-size:12px;color:var(--text2);text-transform:uppercase;border-bottom:1px solid var(--border)">Remarque</th>
        <th></th>
      </tr></thead>
      <tbody id="cmds-tbody"></tbody>
    </table></div>
    <button type="button" class="btn btn-ghost btn-sm" style="margin-top:12px" onclick="openAddCmd()">+ Ajouter commande</button>
  </div>
  <div class="card form-section">
    <div class="section-title">üí¨ Remarques / Observations</div>
    <textarea id="f-rem" rows="4" placeholder="Observations, notes...">${f?f.remarques||'':''}</textarea>
  </div>
  <div class="card form-section">
    <div class="section-title">üìé Plans / Fichiers joints</div>
    <input type="file" id="file-inp" multiple accept="image/*,.pdf" style="display:none" onchange="handleFiles(this.files)"><input type="file" id="camera-inp" accept="image/*" capture="environment" style="display:none" onchange="handleCameraPhoto(this.files[0])"><div style="display:flex;gap:10px;flex-wrap:wrap"><button type="button" class="btn btn-primary" style="flex:1;min-width:150px;padding:16px;font-size:16px;border-radius:12px" onclick="document.getElementById('camera-inp').click()">üì∑ Prendre une photo</button><button type="button" class="btn btn-ghost" style="flex:1;min-width:150px;padding:16px;font-size:16px;border-radius:12px" onclick="document.getElementById('file-inp').click()">üìé Fichier existant</button></div>
    </div>
    <div id="file-preview" style="margin-top:14px;display:flex;flex-wrap:wrap;gap:8px;align-items:flex-start">
      ${existingFiles.map((fl,i)=>fl.type&&fl.type.startsWith('image/')&&fl.data
        ?`<div class="img-thumb-wrap" id="exist-file-${i}"><img src="${fl.data}" alt="${fl.name}" onclick="openLightbox('${fl.data}')"><div class="img-zoom-badge">üîç</div><button class="del-thumb" onclick="removeExistingFile(${i})" title="Supprimer">‚úï</button></div>`
        :`<span class="file-name-badge" id="exist-file-${i}">üìÑ ${fl.name} <button onclick="removeExistingFile(${i})" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:14px;margin-left:4px">‚úï</button></span>`).join('')}
    </div>
  </div>
  <div style="margin-bottom:40px"><button class="btn btn-primary btn-full" onclick="submitFiche()">üíæ Enregistrer la Fiche</button></div>`;
}


function fillDatalistsOptions(){
  console.log('fillDatalistsOptions: fiches.length=',fiches.length);
  console.log('Exemple fiche[0]:', fiches[0]?JSON.stringify({client:fiches[0].client,matiere:fiches[0].matiere}):'aucune');
  const clients=[...new Set(fiches.map(x=>x.client).filter(Boolean))].sort();
  const matieres=[...new Set(fiches.map(x=>x.matiere).filter(Boolean))].sort();
  console.log('clients trouv√©s:',clients);
  console.log('matieres trouv√©es:',matieres);
  const cList=document.getElementById('clients-list');
  const mList=document.getElementById('matieres-list');
  if(cList){
    cList.innerHTML='';
    clients.forEach(c=>{const o=document.createElement('option');o.value=c;cList.appendChild(o);});
  }
  if(mList){
    mList.innerHTML='';
    matieres.forEach(m=>{const o=document.createElement('option');o.value=m;mList.appendChild(o);});
  }
}

function initFormTables(){
  setTimeout(()=>{
    renderOps();renderCmds();
    const backBtn=document.getElementById('form-back');
    if(backBtn)backBtn.onclick=()=>{
      if(editFicheId)goTo('fiche-view',editFicheId);
      else goTo('fiches',currentFilter);
    };
  },50);
}
function renderOps(){
  const tb=document.getElementById('ops-tbody');if(!tb)return;
  tb.innerHTML=formOps.map((op,i)=>`<tr>
    <td style="padding:8px 10px;border-bottom:1px solid var(--border);font-weight:700;color:var(--accent)">${op.opNum}</td>
    <td style="padding:6px 10px;border-bottom:1px solid var(--border)"><input type="text" value="${op.programme||''}" placeholder="N¬∞ Programme" oninput="formOps[${i}].programme=this.value" style="width:100%"></td>
    <td style="padding:6px 10px;border-bottom:1px solid var(--border)"><div style="display:flex;gap:4px;align-items:center"><input type="number" value="${op.tempsMin||''}" placeholder="min" min="0" oninput="formOps[${i}].tempsMin=this.value" style="width:55px"><span style="color:var(--text2);font-size:12px">'</span><input type="number" value="${op.tempsSec||''}" placeholder="sec" min="0" max="59" oninput="formOps[${i}].tempsSec=this.value" style="width:55px"><span style="color:var(--text2);font-size:12px">''</span></div></td>
    <td style="padding:6px 10px;border-bottom:1px solid var(--border)"><input type="text" value="${op.infos||''}" placeholder="Infos..." oninput="formOps[${i}].infos=this.value" style="width:100%;min-width:120px"></td>
    <td style="padding:6px 10px;border-bottom:1px solid var(--border)"><button class="remove-btn" onclick="removeOp(${i})">‚úï</button></td>
  </tr>`).join('');
}
function addOp(){formOps.push({opNum:formOps.length+1,programme:'',tempsCycle:''});renderOps()}
function removeOp(i){formOps.splice(i,1);formOps.forEach((o,idx)=>o.opNum=idx+1);renderOps()}
function renderCmds(){
  const tb=document.getElementById('cmds-tbody');if(!tb)return;
  if(!formCmds.length){tb.innerHTML=`<tr><td colspan="5" style="text-align:center;padding:16px;color:var(--text2);font-size:13px">Aucune commande</td></tr>`;return}
  tb.innerHTML=formCmds.map((c,i)=>`<tr>
    <td style="padding:8px 10px;border-bottom:1px solid var(--border)">${fmt(c.date)}</td>
    <td style="padding:8px 10px;border-bottom:1px solid var(--border)"><strong>${c.num}</strong></td>
    <td style="padding:8px 10px;border-bottom:1px solid var(--border)">${c.qty}</td>
    <td style="padding:8px 10px;border-bottom:1px solid var(--border);color:var(--text2)">${c.remarque||'‚Äî'}</td>
    <td style="padding:6px 10px;border-bottom:1px solid var(--border)"><button class="remove-btn" onclick="removeCmd(${i})">‚úï</button></td>
  </tr>`).join('');
}
function openAddCmd(){
  document.getElementById('cmd-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('cmd-num').value='';document.getElementById('cmd-qty').value='';document.getElementById('cmd-rem').value='';
  openModal('modal-commande');
}
function saveCommande(){
  const date=document.getElementById('cmd-date').value;
  const num=document.getElementById('cmd-num').value.trim();
  const qty=document.getElementById('cmd-qty').value;
  if(!num||!qty){toast('N¬∞ commande et quantit√© obligatoires','error');return}
  formCmds.push({date,num,qty:parseInt(qty),remarque:document.getElementById('cmd-rem').value});
  closeModal('modal-commande');renderCmds();
}
function removeCmd(i){formCmds.splice(i,1);renderCmds()}

function compressImage(file,maxW,maxH,quality){
  return new Promise(resolve=>{
    const reader=new FileReader();
    reader.onload=e=>{
      const img=new Image();
      img.onload=()=>{
        let w=img.width,h=img.height;
        if(w>maxW||h>maxH){
          const ratio=Math.min(maxW/w,maxH/h);
          w=Math.round(w*ratio);h=Math.round(h*ratio);
        }
        const canvas=document.createElement('canvas');
        canvas.width=w;canvas.height=h;
        canvas.getContext('2d').drawImage(img,0,0,w,h);
        resolve(canvas.toDataURL('image/jpeg',quality));
      };
      img.src=e.target.result;
    };
    reader.readAsDataURL(file);
  });
}
function handleFiles(files){
  console.log('handleFiles appel√©, nb fichiers:', files.length);
  for(const file of files){
    console.log('Fichier:', file.name, 'type:', file.type, 'taille:', file.size);
    if(file.type.startsWith('image/')){
      compressImage(file,1200,1200,0.75).then(compressed=>{
        console.log('Compression OK, taille:', Math.round(compressed.length*0.75/1024),'KB');
        const fileData={name:file.name,type:'image/jpeg',data:compressed};
        formFiles.push(fileData);
        console.log('formFiles.length:', formFiles.length);
        const idx=formFiles.length-1;
        const prev=document.getElementById('file-preview');
        console.log('file-preview element:', prev);
        if(prev){
          const wrap=document.createElement('div');
          wrap.className='img-thumb-wrap';
          wrap.id='new-file-'+idx;
          const img=document.createElement('img');
          img.src=compressed;img.alt=file.name;
          img.onclick=function(){openLightbox(this.src);};
          const badge=document.createElement('div');badge.className='img-zoom-badge';badge.textContent='üîç';
          const btn=document.createElement('button');btn.className='del-thumb';btn.title='Supprimer';btn.textContent='‚úï';
          btn.onclick=function(){removeNewFile(idx);};
          wrap.appendChild(img);wrap.appendChild(badge);wrap.appendChild(btn);
          prev.appendChild(wrap);
        }
      });
    } else {
      const reader=new FileReader();
      reader.onload=e=>{
        const fileData={name:file.name,type:file.type,data:e.target.result};
        formFiles.push(fileData);
        const idx=formFiles.length-1;
        const prev=document.getElementById('file-preview');
        if(prev){
          const span=document.createElement('span');
          span.className='file-name-badge';
          span.id='new-file-'+idx;
          span.innerHTML=`üìÑ ${file.name} <button onclick="removeNewFile(${idx})" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:14px;margin-left:4px">‚úï</button>`;
          prev.appendChild(span);
        }
      };
      reader.readAsDataURL(file);
    }
  }
}
function removeNewFile(idx){
  formFiles[idx]=null; // nullify so indices stay stable
  const el=document.getElementById('new-file-'+idx);
  if(el)el.remove();
}
// Suppression fichier existant (depuis le formulaire d'√©dition)
let deletedExistingFiles=[];
function removeExistingFile(idx){
  deletedExistingFiles.push(idx);
  const el=document.getElementById('exist-file-'+idx);
  if(el)el.remove();
}

async function submitFiche(){
  const date=document.getElementById('f-date').value;
  const planRef=document.getElementById('f-plan').value.trim();
  const machineId=document.getElementById('f-machine').value;
  const matiere=document.getElementById('f-mat').value.trim();
  if(!machineId||!matiere){toast('Machine et Mati√®re sont obligatoires','error');return}
  const forme=document.getElementById('f-forme').value;
  const dims=getDimsValues();
  const now=new Date().toISOString();
  const user=currentUser?currentUser.name:'Syst√®me';
  const newFiles=formFiles.filter(Boolean).map(fl=>({name:fl.name,type:fl.type,data:fl.data}));
  if(editFicheId){
    const f=getFiche(editFicheId);
    const changes=[];
    const designation=document.getElementById('f-design').value.trim();
    const client=document.getElementById('f-client').value.trim();
    const remarques=document.getElementById('f-rem').value;
    if(f.planRef!==planRef)changes.push('N¬∞ Plan: "'+f.planRef+'" ‚Üí "'+planRef+'"');
    if(f.designation!==designation)changes.push('D√©signation: "'+f.designation+'" ‚Üí "'+designation+'"');
    if(f.client!==client)changes.push('Client: "'+(f.client||'‚Äî')+'" ‚Üí "'+(client||'‚Äî')+'"');
    if(f.matiere!==matiere)changes.push('Mati√®re: "'+f.matiere+'" ‚Üí "'+matiere+'"');
    if(f.machineId!==machineId){const om=getMachine(f.machineId);const nm=getMachine(machineId);changes.push('Machine: "'+(om?om.nom:'?')+'" ‚Üí "'+(nm?nm.nom:'?')+'"');}
    if(f.remarques!==remarques)changes.push('Remarques modifi√©es');
    if(JSON.stringify(f.operations)!==JSON.stringify(formOps))changes.push('Programmes/Op√©rations modifi√©s');
    if(JSON.stringify(f.commandes)!==JSON.stringify(formCmds))changes.push('Commandes modifi√©es');
    if(newFiles.length)changes.push(newFiles.length+' fichier(s) ajout√©(s)');
    if(deletedExistingFiles.length)changes.push(deletedExistingFiles.length+' fichier(s) supprim√©(s)');
    const hist=f.history||[];
    hist.push({date:now,user,action:changes.length?changes.join(' | '):'Fiche consult√©e/sauvegard√©e'});
    const keptFiles=(f.files||[]).filter((_,i)=>!deletedExistingFiles.includes(i));
    Object.assign(f,{date,client:document.getElementById('f-client').value.trim(),planRef,designation:document.getElementById('f-design').value.trim(),machineId,matiere,forme,dims,operations:JSON.parse(JSON.stringify(formOps)),commandes:JSON.parse(JSON.stringify(formCmds)),remarques:document.getElementById('f-rem').value,files:[...keptFiles,...newFiles],updatedAt:now,history:hist});
    await svFiches_update(f);
    toast('Fiche modifi√©e');goTo('fiche-view',editFicheId);
  }else{
    const nf={id:genId(),date,client:document.getElementById('f-client').value.trim(),planRef,designation:document.getElementById('f-design').value.trim(),machineId,matiere,forme,dims,operations:JSON.parse(JSON.stringify(formOps)),commandes:JSON.parse(JSON.stringify(formCmds)),remarques:document.getElementById('f-rem').value,files:newFiles,createdAt:now,updatedAt:now,createdBy:user,history:[{date:now,user,action:'Fiche cr√©√©e'}]};
    fiches.push(nf);
    await svFiches_add(nf);
    toast('Fiche cr√©√©e');goTo('fiche-view',nf.id);
  }
}

// ‚îÄ‚îÄ FICHE VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderFicheView(id){
  currentFicheId=id;
  const f=getFiche(id);if(!f)return'<p>Fiche introuvable</p>';
  const m=getMachine(f.machineId)||{color:'#888',nom:'?',type:'?'};
  const totalQty=(f.commandes||[]).reduce((a,c)=>a+c.qty,0);
  const dimsStr=formatDimsDisplay(f.forme,f.dims);

  // fichiers ‚Äî on s√©pare images (avec data) et autres
  const hasFiles=f.files&&f.files.length;
  let filesHtml='';
  if(hasFiles){
    const imgs=f.files.filter(fl=>fl.type&&fl.type.startsWith('image/')&&fl.data);
    const others=f.files.filter(fl=>!(fl.type&&fl.type.startsWith('image/')&&fl.data));
    filesHtml=`<div class="card" style="margin-bottom:16px"><div class="section-title">üìé Fichiers joints</div>
      ${imgs.length?`<div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:${others.length?'12px':'0'}">
        ${f.files.map((fl,i)=>fl.type&&fl.type.startsWith('image/')&&fl.data?`<div class="img-thumb-wrap"><img src="${fl.data}" alt="${fl.name}" onclick="openLightbox('${fl.data}')"><div class="img-zoom-badge">üîç</div><button class="del-thumb" onclick="deleteFileFromFiche('${id}',${i})" title="Supprimer">‚úï</button></div>`:'').join('')}
      </div>`:''}
      ${others.length?`<div style="display:flex;flex-wrap:wrap;gap:8px">${f.files.map((fl,i)=>!(fl.type&&fl.type.startsWith('image/')&&fl.data)?`<span class="file-name-badge">${fl.type==="application/pdf"?"üìï":"üìÑ"} ${fl.name} ${fl.data?`<button onclick="openFile('${fl.data}','${fl.type}')" style="background:none;border:none;color:var(--accent);cursor:pointer;font-size:12px;margin-left:6px;text-decoration:underline">Ouvrir</button>`:""}  <button onclick="deleteFileFromFiche('${id}',${i})" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:14px;margin-left:4px">‚úï</button></span>`:'').join('')}</div>`:''}
    </div>`;
  }

  return`<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px" class="no-print">
    <div style="display:flex;align-items:center;gap:14px">
      <button class="back-btn" onclick="goTo('fiches',{machineId:'${f.machineId}'})">‚Üê Retour</button>
      <div><h2 style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:800">${f.designation||f.planRef||'Sans titre'}</h2>
      <div style="color:${m.color};font-size:14px">${m.nom} ¬∑ ${m.type}</div></div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost no-print" onclick="printFiche()">üñ®Ô∏è Imprimer</button>
      <button class="btn btn-blue no-print" onclick="goTo('fiche-edit','${id}')">‚úèÔ∏è Modifier</button>
      <button class="btn btn-red no-print" onclick="confirmDelFiche('${id}')">üóëÔ∏è</button>
    </div>
  </div>
  <div id="print-area">
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
    <div class="card"><div class="section-title">‚ÑπÔ∏è Informations</div>
      <div class="info-grid">
        <div><div class="info-label">Date</div><div class="info-val">${fmt(f.date)}</div></div>
        <div><div class="info-label">Client</div><div class="info-val">${f.client||'‚Äî'}</div></div>
        <div><div class="info-label">N¬∞ Plan</div><div class="info-val">${f.planRef||'‚Äî'}</div></div>
        <div><div class="info-label">D√©signation</div><div class="info-val">${f.designation||'‚Äî'}</div></div>
      </div>
    </div>
    <div class="card"><div class="section-title">üî© Mati√®re & Brut</div>
      <div class="info-grid">
        <div><div class="info-label">Mati√®re</div><div class="info-val">${f.matiere||'‚Äî'}</div></div>
        <div><div class="info-label">Forme</div><div class="info-val">${f.forme||'‚Äî'}</div></div>
        <div style="grid-column:span 2"><div class="info-label">Dimensions</div><div class="info-val" style="font-size:13px">${dimsStr}</div></div>
      </div>
    </div>
  </div>
  <div class="card" style="margin-bottom:16px"><div class="section-title">‚öôÔ∏è Programmes / Op√©rations</div>
    ${!(f.operations||[]).length?'<p style="color:var(--text2);font-size:13px">Aucune op√©ration</p>':`
    <table style="width:100%;border-collapse:collapse"><thead><tr>
      <th style="text-align:left;padding:8px 12px;font-size:12px;color:var(--text2);text-transform:uppercase;border-bottom:1px solid var(--border)">OP N¬∞</th>
      <th style="text-align:left;padding:8px 12px;font-size:12px;color:var(--text2);text-transform:uppercase;border-bottom:1px solid var(--border)">N¬∞ Programme</th>
      <th style="text-align:left;padding:8px 12px;font-size:12px;color:var(--text2);text-transform:uppercase;border-bottom:1px solid var(--border)">Temps Cycle</th>
      <th style="text-align:left;padding:8px 12px;font-size:12px;color:var(--text2);text-transform:uppercase;border-bottom:1px solid var(--border)">Infos</th>
    </tr></thead><tbody>
    ${(f.operations||[]).map(op=>`<tr>
      <td style="padding:10px 12px;border-bottom:1px solid var(--border)"><strong style="color:var(--accent)">${op.opNum}</strong></td>
      <td style="padding:10px 12px;border-bottom:1px solid var(--border)">${op.programme||'‚Äî'}</td>
      <td style="padding:10px 12px;border-bottom:1px solid var(--border)">${(op.tempsMin||op.tempsSec)?(op.tempsMin?op.tempsMin+"'":'')+(op.tempsSec?op.tempsSec+'"':''):'‚Äî'}</td>
      <td style="padding:10px 12px;border-bottom:1px solid var(--border);color:var(--text2);font-size:13px">${op.infos||'‚Äî'}</td>
    </tr>`).join('')}
    </tbody></table>`}
  </div>
  <div class="card" style="margin-bottom:16px"><div class="section-title">üì¶ Historique des Commandes${totalQty>0?` <span style="font-size:14px;font-weight:400;color:var(--text2)">‚Äî Total : ${totalQty} pcs</span>`:''}</div>
    ${!(f.commandes||[]).length?'<p style="color:var(--text2);font-size:13px">Aucune commande</p>':`
    <table style="width:100%;border-collapse:collapse"><thead><tr>
      <th style="text-align:left;padding:8px 12px;font-size:12px;color:var(--text2);text-transform:uppercase;border-bottom:1px solid var(--border)">Date</th>
      <th style="text-align:left;padding:8px 12px;font-size:12px;color:var(--text2);text-transform:uppercase;border-bottom:1px solid var(--border)">N¬∞ Commande</th>
      <th style="text-align:left;padding:8px 12px;font-size:12px;color:var(--text2);text-transform:uppercase;border-bottom:1px solid var(--border)">Quantit√©</th>
      <th style="text-align:left;padding:8px 12px;font-size:12px;color:var(--text2);text-transform:uppercase;border-bottom:1px solid var(--border)">Remarque</th>
    </tr></thead><tbody>
    ${(f.commandes||[]).map(c=>`<tr>
      <td style="padding:10px 12px;border-bottom:1px solid var(--border)">${fmt(c.date)}</td>
      <td style="padding:10px 12px;border-bottom:1px solid var(--border)"><strong>${c.num}</strong></td>
      <td style="padding:10px 12px;border-bottom:1px solid var(--border)"><span style="background:var(--blue)20;color:var(--blue2);padding:3px 10px;border-radius:20px;font-size:12px;font-weight:600">${c.qty} pcs</span></td>
      <td style="padding:10px 12px;border-bottom:1px solid var(--border);color:var(--text2)">${c.remarque||'‚Äî'}</td>
    </tr>`).join('')}
    </tbody></table>`}
  </div>
  ${f.remarques?`<div class="card" style="margin-bottom:16px"><div class="section-title">üí¨ Remarques</div><p style="font-size:14px;line-height:1.7;color:var(--text2)">${f.remarques}</p></div>`:''}
  ${filesHtml}
  <div class="card" style="margin-bottom:40px"><div class="section-title">üìã Historique des modifications</div>
    ${!(f.history||[]).length?'<p style="color:var(--text2);font-size:13px">Aucun historique</p>':
    (f.history||[]).slice().reverse().map(h=>`<div class="history-item"><div class="history-dot"></div><div><div class="history-text">${h.action}</div><div class="history-date">${new Date(h.date).toLocaleString('fr-FR')} ‚Äî ${h.user}</div></div></div>`).join('')}
  </div>
  </div>`;
}

// ‚îÄ‚îÄ PRINT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function printFiche(){
  const id=currentFicheId;
  if(!id)return toast('Aucune fiche s√©lectionn√©e','error');
  const f=getFiche(id);
  if(!f)return toast('Fiche introuvable','error');
  const m=getMachine(f.machineId)||{color:'#2952b3',nom:'?',type:'?'};
  const totalQty=(f.commandes||[]).reduce((a,c)=>a+c.qty,0);
  const dimsStr=formatDimsDisplay(f.forme,f.dims);
  const now=new Date().toLocaleString('fr-FR');
  const ops=f.operations||[];
  const cmds=f.commandes||[];
  const imgs=(f.files||[]).filter(fl=>fl.type&&fl.type.startsWith('image/')&&fl.data);

  const opsRows=ops.length===0
    ?'<tr><td colspan="3" style="color:#888;font-style:italic;padding:8px">Aucune op√©ration</td></tr>'
    :ops.map(op=>`<tr><td><b>${op.opNum}</b></td><td>${op.programme||'‚Äî'}</td><td>${op.tempsCycle?op.tempsCycle+' mn':'‚Äî'}</td></tr>`).join('');

  const cmdsRows=cmds.length===0
    ?'<tr><td colspan="4" style="color:#888;font-style:italic;padding:8px">Aucune commande</td></tr>'
    :cmds.map(c=>`<tr><td>${fmt(c.date)}</td><td><b>${c.num}</b></td><td>${c.qty} pcs</td><td>${c.remarque||'‚Äî'}</td></tr>`).join('');

  const imgsHtml=imgs.length?`<div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px">${imgs.map(fl=>`<img src="${fl.data}" style="width:100px;height:100px;object-fit:cover;border-radius:5px;border:1px solid #ddd">`).join('')}</div>`:'';

  const html=`<!DOCTYPE html><html lang="fr"><head><meta charset="UTF-8">
<link rel="manifest" href="manifest.json">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MCS App">
<meta name="theme-color" content="#2952b3">
<title>Fiche ${f.planRef||f.designation||'MCS'}</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,Helvetica,sans-serif;font-size:11px;color:#000;background:#fff;padding:10mm 12mm}
.hd{display:flex;align-items:center;gap:14px;padding-bottom:10px;margin-bottom:14px;border-bottom:3px solid ${m.color}}
.hd img{height:54px;width:auto;flex-shrink:0}
.hd-txt{flex:1}
.hd-txt h1{font-size:19px;font-weight:800;margin-bottom:3px}
.hd-txt p{font-size:9px;color:#666}
.mtag{border:2px solid ${m.color};border-radius:8px;padding:6px 12px;color:${m.color};font-weight:700;font-size:12px;text-align:center;line-height:1.4;white-space:nowrap}
.mtag small{display:block;font-size:9px;color:#888;font-weight:400}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
.bx{border:1px solid #ddd;border-radius:6px;padding:10px;break-inside:avoid}
.bt{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:#444;border-bottom:1px solid #eee;padding-bottom:5px;margin-bottom:8px}
.r2{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.lb{font-size:8px;color:#999;text-transform:uppercase;margin-bottom:2px}
.vl{font-size:11px;font-weight:600}
table{width:100%;border-collapse:collapse;margin-top:6px}
thead tr{background:#f5f5f5}
th{text-align:left;padding:5px 8px;font-size:9px;font-weight:700;text-transform:uppercase;color:#555;border-bottom:2px solid #ddd}
td{padding:5px 8px;font-size:10px;border-bottom:1px solid #f0f0f0}
.ft{margin-top:14px;padding-top:8px;border-top:1px solid #ddd;display:flex;justify-content:space-between;font-size:9px;color:#aaa}
@page{margin:8mm}

#crop-modal{position:fixed;inset:0;background:rgba(0,0,0,0.93);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px}
#crop-modal.hidden{display:none}
#crop-container{position:relative;display:inline-block;max-width:90vw}
#crop-img{display:block;max-width:90vw;max-height:65vh;object-fit:contain}
#crop-box{position:absolute;border:3px solid #fff;box-shadow:0 0 0 9999px rgba(0,0,0,0.55);cursor:move;touch-action:none;box-sizing:border-box}
.crop-handle{position:absolute;width:28px;height:28px;background:#fff;border-radius:50%;border:2px solid #1e2d55;touch-action:none;z-index:10}
.crop-handle.tl{top:-14px;left:-14px}.crop-handle.tr{top:-14px;right:-14px}
.crop-handle.bl{bottom:-14px;left:-14px}.crop-handle.br{bottom:-14px;right:-14px}

</style></head><body>
<div class="hd">
  <img src="${LOGO_DATA}" alt="MCS">
  <div class="hd-txt"><h1>M√©canique Concept Saar ‚Äî Fiche de Production</h1><p>Imprim√©e le ${now}</p></div>
  <div class="mtag">${m.nom}<small>${m.type}</small></div>
</div>
<div class="g2">
  <div class="bx"><div class="bt">Informations g√©n√©rales</div>
    <div class="r2">
      <div><div class="lb">Date</div><div class="vl">${fmt(f.date)}</div></div>
      <div><div class="lb">Client</div><div class="vl">${f.client||'‚Äî'}</div></div>
      <div><div class="lb">N¬∞ Plan</div><div class="vl">${f.planRef||'‚Äî'}</div></div>
      <div><div class="lb">D√©signation</div><div class="vl">${f.designation||'‚Äî'}</div></div>
    </div>
  </div>
  <div class="bx"><div class="bt">Mati√®re & Brut</div>
    <div class="r2">
      <div><div class="lb">Mati√®re</div><div class="vl">${f.matiere||'‚Äî'}</div></div>
      <div><div class="lb">Forme</div><div class="vl">${f.forme||'‚Äî'}</div></div>
      <div style="grid-column:span 2"><div class="lb">Dimensions</div><div class="vl" style="font-size:10px">${dimsStr}</div></div>
    </div>
  </div>
</div>
<div class="bx" style="margin-bottom:10px"><div class="bt">Programmes / Op√©rations</div>
  <table><thead><tr><th>OP N¬∞</th><th>N¬∞ Programme</th><th>Temps Cycle</th></tr></thead><tbody>${opsRows}</tbody></table>
</div>
<div class="bx" style="margin-bottom:10px"><div class="bt">Commandes${totalQty>0?' ‚Äî Total : '+totalQty+' pcs':''}</div>
  <table><thead><tr><th>Date</th><th>N¬∞ Commande</th><th>Qt√©</th><th>Remarque</th></tr></thead><tbody>${cmdsRows}</tbody></table>
</div>
${f.remarques?`<div class="bx" style="margin-bottom:10px"><div class="bt">Remarques</div><p style="margin-top:6px;font-size:11px;line-height:1.7;color:#333">${f.remarques}</p></div>`:''}
${imgsHtml?`<div class="bx" style="margin-bottom:10px"><div class="bt">Photos & Plans joints</div>${imgsHtml}</div>`:''}
<div class="ft"><span>MCS ‚Äî M√©canique Concept Saar</span><span>R√©f : ${f.planRef||f.id}</span><span>${now}</span></div>
<script>window.addEventListener('load',function(){setTimeout(function(){window.print()},400);})<\/script>
<div id="crop-modal" class="hidden">
  <div style="color:#fff;font-size:17px;font-weight:700;margin-bottom:14px">‚úÇÔ∏è Recadrer la photo</div>
  <div id="crop-container">
    <img id="crop-img" src="" draggable="false" alt="">
    <div id="crop-box">
      <div class="crop-handle tl" data-corner="tl"></div>
      <div class="crop-handle tr" data-corner="tr"></div>
      <div class="crop-handle bl" data-corner="bl"></div>
      <div class="crop-handle br" data-corner="br"></div>
    </div>
  </div>
  <div style="color:rgba(255,255,255,0.5);font-size:12px;margin:10px 0">üëÜ Glisse les coins pour recadrer</div>
  <div style="display:flex;gap:12px">
    <button class="btn btn-ghost" onclick="cancelCrop()" style="min-width:120px;padding:12px 20px">‚úï Annuler</button>
    <button class="btn btn-primary" onclick="confirmCrop()" style="min-width:120px;padding:12px 20px">‚úÖ Valider</button>
  </div>
</div>
</body></html>`;

  const blob=new Blob([html],{type:'text/html;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.target='_blank';a.rel='noopener';
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url),15000);
}



// ‚îÄ‚îÄ STATS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderStats(){
  const fpm=machines.map(m=>({name:m.nom,count:fiches.filter(f=>f.machineId===m.id).length,color:m.color})).sort((a,b)=>b.count-a.count);
  const maxFPM=Math.max(...fpm.map(x=>x.count),1);
  const mats={};fiches.forEach(f=>{if(f.matiere)mats[f.matiere]=(mats[f.matiere]||0)+1});
  const matList=Object.entries(mats).sort((a,b)=>b[1]-a[1]).slice(0,6);
  const matColors=['#f39c12','#3498db','#2ecc71','#e74c3c','#9b59b6','#1abc9c'];
  const avgOps=fiches.length?(fiches.reduce((a,f)=>a+(f.operations||[]).length,0)/fiches.length).toFixed(1):0;
  // Fiches par mois (6 derniers)
  const fichesByMonth={};
  fiches.forEach(f=>{if(!f.date)return;const k=f.date.slice(0,7);fichesByMonth[k]=(fichesByMonth[k]||0)+1});
  const months=Object.keys(fichesByMonth).sort().slice(-6);
  const maxFM=Math.max(...months.map(m=>fichesByMonth[m]),1);

  return`<h1 class="page-title">Statistiques</h1><p class="page-sub">Analyse de la production</p>
  <div class="stats-grid" style="margin-bottom:24px">
    <div class="stat-card blue"><div class="stat-icon">üè≠</div><div class="stat-val">${machines.length}</div><div class="stat-label">Machines</div></div>
    <div class="stat-card orange"><div class="stat-icon">üìÑ</div><div class="stat-val">${fiches.length}</div><div class="stat-label">Fiches cr√©√©es</div></div>
    <div class="stat-card green"><div class="stat-icon">‚öôÔ∏è</div><div class="stat-val">${avgOps}</div><div class="stat-label">Ops. moy. / fiche</div></div>
    <div class="stat-card purple"><div class="stat-icon">üî©</div><div class="stat-val">${Object.keys(mats).length}</div><div class="stat-label">Mati√®res diff√©rentes</div></div>
  </div>
  <div class="charts-grid">
    <div class="chart-card"><h4>Fiches par Machine</h4>
      ${fpm.length?fpm.map(x=>`<div class="bar-item"><div class="bar-label" title="${x.name}">${x.name}</div><div class="bar-track"><div class="bar-fill" style="width:${x.count/maxFPM*100}%;background:${x.color}">${x.count||''}</div></div><div class="bar-val">${x.count}</div></div>`).join(''):'<p style="color:var(--text2)">Aucune donn√©e</p>'}
    </div>
    <div class="chart-card"><h4>Mati√®res utilis√©es</h4>
      ${matList.length?matList.map((m,i)=>`<div class="bar-item"><div class="bar-label">${m[0]}</div><div class="bar-track"><div class="bar-fill" style="width:${m[1]/matList[0][1]*100}%;background:${matColors[i]}">${m[1]||''}</div></div><div class="bar-val">${m[1]}</div></div>`).join(''):'<p style="color:var(--text2)">Aucune donn√©e</p>'}
    </div>
    <div class="chart-card"><h4>Fiches cr√©√©es par mois</h4>
      ${months.length?months.map(m=>`<div class="bar-item"><div class="bar-label">${m}</div><div class="bar-track"><div class="bar-fill" style="width:${fichesByMonth[m]/maxFM*100}%;background:var(--accent)">${fichesByMonth[m]||''}</div></div><div class="bar-val">${fichesByMonth[m]}</div></div>`).join(''):'<p style="color:var(--text2)">Aucune donn√©e</p>'}
    </div>
    <div class="chart-card"><h4>Activit√© r√©cente</h4>
      <div style="max-height:220px;overflow-y:auto">
      ${fiches.length?[...fiches].sort((a,b)=>new Date(b.updatedAt||b.date)-new Date(a.updatedAt||a.date)).slice(0,10).map(f=>{const m=getMachine(f.machineId)||{color:'#888',nom:'?'};return`<div class="history-item"><div class="history-dot" style="background:${m.color}"></div><div><div class="history-text">${f.designation||f.planRef||'Sans titre'}</div><div class="history-date">${fmt(f.updatedAt||f.date)} ‚Äî ${m.nom}</div></div></div>`}).join(''):'<p style="color:var(--text2)">Aucune fiche</p>'}
      </div>
    </div>
  </div>`;
}

function openFile(data,type){
  const win=window.open('','_blank');
  if(!win){toast('Autorisez les popups pour ouvrir le fichier','error');return;}
  if(type==='application/pdf'){
    win.document.write('<html><body style="margin:0"><iframe src="'+data+'" style="width:100%;height:100vh;border:none"></iframe></body></html>');
  } else {
    win.document.write('<html><body style="margin:0;background:#000;display:flex;align-items:center;justify-content:center;min-height:100vh"><img src="'+data+'" style="max-width:100%;max-height:100vh"></body></html>');
  }
}
// ‚îÄ‚îÄ DELETE FILE FROM VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function deleteFileFromFiche(ficheId,fileIdx){
  document.getElementById('delete-msg').textContent='Supprimer ce fichier joint ? Cette action est irr√©versible.';
  document.getElementById('delete-ok').onclick=async()=>{
    const f=getFiche(ficheId);if(!f||!f.files)return;
    f.files.splice(fileIdx,1);
    await svFiches_update(f);
    closeModal('modal-delete');
    toast('Fichier supprim√©');
    goTo('fiche-view',ficheId);
  };
  openModal('modal-delete');
}

// ‚îÄ‚îÄ PARAM√àTRES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSettings(){
  return`<h1 class="page-title">Param√®tres</h1><p class="page-sub">Configuration et gestion de l'application</p>

  <div class="card" style="margin-bottom:20px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
      <div class="section-title" style="margin-bottom:0;border-bottom:none;padding-bottom:0">üè≠ Gestion des Machines</div>
      <button class="btn btn-primary btn-sm" onclick="openAddMachine()">+ Ajouter une machine</button>
    </div>
    ${machines.length===0?`<div class="empty-state" style="padding:24px"><div class="empty-icon">üè≠</div><p>Aucune machine configur√©e</p></div>`:`
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px">
      ${machines.map(m=>{const cnt=fiches.filter(f=>f.machineId===m.id).length;return`
      <div style="background:${m.color}18;border:1px solid ${m.color}50;border-radius:12px;padding:16px;position:relative">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
          <div style="width:14px;height:14px;border-radius:50%;background:${m.color};flex-shrink:0"></div>
          <strong style="color:${m.color};font-size:15px">${m.nom}</strong>
        </div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:10px">${m.type} ¬∑ ${cnt} fiche${cnt>1?'s':''}</div>
        <div style="display:flex;gap:6px">
          <button class="btn btn-ghost btn-sm" style="flex:1" onclick="openEditMachine('${m.id}')">‚úèÔ∏è Modifier</button>
          <button class="btn btn-ghost btn-sm" onclick="confirmDelMachine('${m.id}')">üóëÔ∏è</button>
        </div>
      </div>`}).join('')}
    </div>`}
  </div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
    <div class="card">
      <div class="section-title">üë§ Compte</div>
      <div class="info-grid" style="margin-bottom:16px">
        <div><div class="info-label">Utilisateur</div><div class="info-val">${currentUser?currentUser.name:'‚Äî'}</div></div>
        <div><div class="info-label">R√¥le</div><div class="info-val" style="text-transform:capitalize">${currentUser?currentUser.role:'‚Äî'}</div></div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="doLogout()">üîì Se d√©connecter</button>
    </div>
    <div class="card">
      <div class="section-title">‚òÅÔ∏è Stockage Cloud</div>
      <div class="info-grid" style="margin-bottom:4px">
        <div><div class="info-label">Fiches</div><div class="info-val">${fiches.length}</div></div>
        <div><div class="info-label">Machines</div><div class="info-val">${machines.length}</div></div>
        <div><div class="info-label">Base de donn√©es</div><div class="info-val" style="color:#2ecc71">‚úÖ Supabase</div></div>
        <div><div class="info-label">Multi-utilisateurs</div><div class="info-val" style="color:#2ecc71">‚úÖ Activ√©</div></div>
      </div>
      <button class="btn btn-ghost btn-sm" style="margin-top:8px" onclick="refreshData()">üîÑ Actualiser les donn√©es</button>
    </div>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
    <div class="card">
      <div class="section-title">üì§ Export des donn√©es</div>
      <p style="font-size:13px;color:var(--text2);margin-bottom:16px;line-height:1.6">Sauvegarder toutes les fiches et machines au format JSON.</p>
      <button class="btn btn-blue btn-sm" onclick="exportData()">üì• Exporter JSON</button>
    </div>
    <div class="card">
      <div class="section-title">üì• Import des donn√©es</div>
      <p style="font-size:13px;color:var(--text2);margin-bottom:16px;line-height:1.6">Importer un fichier JSON export√©. Les donn√©es seront fusionn√©es.</p>
      <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(this.files[0])">
      <button class="btn btn-ghost btn-sm" onclick="document.getElementById('import-file').click()">üìÇ Importer JSON</button>
    </div>
  </div>
`;
}

function exportData(){
  const blob=new Blob([JSON.stringify({version:1,exportedAt:new Date().toISOString(),machines,fiches},null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='MCS_backup_'+new Date().toISOString().slice(0,10)+'.json';
  a.click();toast('Export r√©ussi !');
}
async function importData(file){
  if(!file)return;
  const reader=new FileReader();
  reader.onload=async e=>{
    try{
      const data=JSON.parse(e.target.result);
      const newMachines=(data.machines||[]).filter(m=>!getMachine(m.id));
      const newFiches=(data.fiches||[]).filter(f=>!getFiche(f.id));
      for(const m of newMachines){machines.push(m);await svMachines_add(m)}
      for(const f of newFiches){fiches.push(f);await svFiches_add(f)}
      toast('Import r√©ussi : '+newFiches.length+' fiches');
      goTo('settings');
    }catch(err){toast('Fichier invalide','error')}
  };
  reader.readAsText(file);
}
async function confirmResetAll(){
  document.getElementById('delete-msg').textContent='Supprimer TOUTES les fiches et machines ? Cette action est irr√©versible !';
  document.getElementById('delete-ok').onclick=async()=>{
    fiches=[];machines=[];
    await svFiches_deleteAll();
    await sbDeleteAll('machines');
    closeModal('modal-delete');goTo('home');toast('Toutes les donn√©es supprim√©es');
  };
  openModal('modal-delete');
}// ‚îÄ‚îÄ PWA INSTALL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();
  deferredPrompt=e;
  const btn=document.getElementById('pwa-install-btn');
  if(btn)btn.classList.remove('hidden');
});
window.addEventListener('appinstalled',()=>{
  deferredPrompt=null;
  const btn=document.getElementById('pwa-install-btn');
  if(btn)btn.classList.add('hidden');
  toast('Application install√©e ! ‚úì');
});
async function installPWA(){
  if(!deferredPrompt)return;
  deferredPrompt.prompt();
  const {outcome}=await deferredPrompt.userChoice;
  deferredPrompt=null;
}

async function refreshData(silent=false){
  if(!silent) toast('Actualisation en cours...');
  await loadAllData();
  const page=currentPage;
  // Recharge silencieusement si on est sur une page liste ou home
  if(['home','fiches','fiche-view','stats'].includes(page)){
    goTo(page,currentFilter);
  }
  if(!silent) toast('Donn√©es actualis√©es ‚úì');
}

// Auto-refresh toutes les 30 secondes
setInterval(()=>{
  if(currentUser && dbReady) refreshData(true);
}, 30000);

// ===== CROP PHOTO =====
var _cFile=null,_cDrag=null,_cSX=0,_cSY=0,_cBox={x:0,y:0,w:0,h:0};
function handleCameraPhoto(file){
  if(!file)return;
  var r=new FileReader();
  r.onload=function(e){
    _cFile=file;
    var modal=document.getElementById('crop-modal');
    var img=document.getElementById('crop-img');
    modal.classList.remove('hidden');
    img.onload=function(){
      var W=this.offsetWidth,H=this.offsetHeight,p=Math.min(W,H)*0.05;
      _cBox={x:p,y:p,w:W-p*2,h:H-p*2};
      _drawCrop();
    };
    img.src=e.target.result;
  };
  r.readAsDataURL(file);
}
function _drawCrop(){
  var b=document.getElementById('crop-box');
  if(b){b.style.left=_cBox.x+'px';b.style.top=_cBox.y+'px';b.style.width=_cBox.w+'px';b.style.height=_cBox.h+'px';}
}
function cancelCrop(){
  document.getElementById('crop-modal').classList.add('hidden');
  var i=document.getElementById('camera-inp');if(i)i.value='';
  _cFile=null;
}
function confirmCrop(){
  var img=document.getElementById('crop-img');
  var sx=img.naturalWidth/img.offsetWidth,sy=img.naturalHeight/img.offsetHeight;
  var canvas=document.createElement('canvas');
  var sw=_cBox.w*sx,sh=_cBox.h*sy,sc=sw>1600?1600/sw:1;
  canvas.width=Math.round(sw*sc);canvas.height=Math.round(sh*sc);
  canvas.getContext('2d').drawImage(img,_cBox.x*sx,_cBox.y*sy,sw,sh,0,0,canvas.width,canvas.height);
  var q=0.85,res=canvas.toDataURL('image/jpeg',q);
  while(res.length>273066&&q>0.15){q-=0.05;res=canvas.toDataURL('image/jpeg',q);}
  var nm=(_cFile?_cFile.name.replace(/\.[^.]+$/,''):'photo')+'.jpg';
  formFiles.push({name:nm,type:'image/jpeg',data:res});
  var ix=formFiles.length-1;
  var prev=document.getElementById('file-preview');
  if(prev){
    var wrap=document.createElement('div');
    wrap.className='img-thumb-wrap';wrap.id='new-file-'+ix;
    wrap.innerHTML='<img src="'+res+'" alt="'+nm+'" onclick="openLightbox(this.src)" style="cursor:zoom-in"><button class="img-del-btn" onclick="removeNewFile('+ix+')">‚úï</button>';
    prev.appendChild(wrap);
  }
  document.getElementById('crop-modal').classList.add('hidden');
  var ci=document.getElementById('camera-inp');if(ci)ci.value='';
  _cFile=null;
  toast('Photo ajout√©e (~'+Math.round(res.length*0.75/1024)+' KB)','success');
}
(function(){
  function gp(e){return e.touches?{x:e.touches[0].clientX,y:e.touches[0].clientY}:{x:e.clientX,y:e.clientY};}
  function cl(v,a,b){return Math.max(a,Math.min(b,v));}
  function start(e){
    var modal=document.getElementById('crop-modal');
    if(!modal||modal.classList.contains('hidden'))return;
    var h=e.target.closest('.crop-handle'),box=document.getElementById('crop-box');
    if(h){_cDrag='h:'+h.dataset.corner;e.preventDefault();}
    else if(box&&(e.target===box||box.contains(e.target))){_cDrag='move';e.preventDefault();}
    if(_cDrag){var p=gp(e);_cSX=p.x;_cSY=p.y;}
  }
  function move(e){
    if(!_cDrag)return;e.preventDefault();
    var p=gp(e),dx=p.x-_cSX,dy=p.y-_cSY;_cSX=p.x;_cSY=p.y;
    var img=document.getElementById('crop-img'),W=img.offsetWidth,H=img.offsetHeight,M=50;
    var x=_cBox.x,y=_cBox.y,w=_cBox.w,h=_cBox.h;
    if(_cDrag==='move'){x=cl(x+dx,0,W-w);y=cl(y+dy,0,H-h);}
    else{var c=_cDrag.split(':')[1];
      if(c==='tl'){var nx=cl(x+dx,0,x+w-M),ny=cl(y+dy,0,y+h-M);w+=x-nx;h+=y-ny;x=nx;y=ny;}
      else if(c==='tr'){w=cl(w+dx,M,W-x);var ny2=cl(y+dy,0,y+h-M);h+=y-ny2;y=ny2;}
      else if(c==='bl'){var nx2=cl(x+dx,0,x+w-M);w+=x-nx2;x=nx2;h=cl(h+dy,M,H-y);}
      else if(c==='br'){w=cl(w+dx,M,W-x);h=cl(h+dy,M,H-y);}
    }
    _cBox={x:x,y:y,w:w,h:h};_drawCrop();
  }
  function end(){_cDrag=null;}
  document.addEventListener('mousedown',start);
  document.addEventListener('touchstart',start,{passive:false});
  document.addEventListener('mousemove',move);
  document.addEventListener('touchmove',move,{passive:false});
  document.addEventListener('mouseup',end);
  document.addEventListener('touchend',end);
})();

</script><div id="crop-modal" class="hidden">
  <div style="color:#fff;font-size:17px;font-weight:700;margin-bottom:14px">‚úÇÔ∏è Recadrer la photo</div>
  <div id="crop-container">
    <img id="crop-img" src="" draggable="false" alt="">
    <div id="crop-box">
      <div class="crop-handle tl" data-corner="tl"></div>
      <div class="crop-handle tr" data-corner="tr"></div>
      <div class="crop-handle bl" data-corner="bl"></div>
      <div class="crop-handle br" data-corner="br"></div>
    </div>
  </div>
  <div style="color:rgba(255,255,255,0.5);font-size:12px;margin:10px 0">üëÜ Glisse les coins pour recadrer</div>
  <div style="display:flex;gap:12px">
    <button class="btn btn-ghost" onclick="cancelCrop()" style="min-width:120px;padding:12px 20px">‚úï Annuler</button>
    <button class="btn btn-primary" onclick="confirmCrop()" style="min-width:120px;padding:12px 20px">‚úÖ Valider</button>
  </div>
</div>
</body></html>
